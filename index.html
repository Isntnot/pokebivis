<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Monster Game</title>
<style>
body{
  margin:0;
  background:#9bbc0f;
  overflow:hidden;
  font-family:monospace;
}

#game{
  display:block;
  margin:auto;
  border:4px solid #0f380f;
  image-rendering:pixelated;
}

#ui{
  position:fixed;
  inset:0;
  pointer-events:none;
}

#joystick{
  position:absolute;
  bottom:30px;
  left:30px;
  width:120px;
  height:120px;
  border-radius:50%;
  background:rgba(0,0,0,0.2);
  pointer-events:auto;
}

#stick{
  position:absolute;
  width:50px;
  height:50px;
  border-radius:50%;
  background:rgba(255,255,255,0.6);
  top:35px;
  left:35px;
}

.btn{
  position:absolute;
  background:#306230;
  color:white;
  padding:10px;
  border-radius:8px;
  pointer-events:auto;
  user-select:none;
}

#menuBtn{ top:20px; right:20px; }
#attack1{ bottom:120px; right:30px; }
#attack2{ bottom:60px; right:30px; }
#captureBtn{ bottom:20px; right:30px; }

.hidden{ display:none; }

</style>
</head>
<body>

<canvas id="game" width="320" height="288"></canvas>

<div id="ui">
  <div id="joystick">
    <div id="stick"></div>
  </div>

  <div id="menuBtn" class="btn">MENU</div>

  <div id="attack1" class="btn hidden">ATK 1</div>
  <div id="attack2" class="btn hidden">ATK 2</div>
  <div id="captureBtn" class="btn hidden">CAPTURE</div>
</div>

<script>
const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");
ctx.font="12px monospace";
ctx.textBaseline="top";

function resize(){
 const scale=Math.floor(
  Math.min(
   window.innerWidth/canvas.width,
   window.innerHeight/canvas.height
  )
 );
 canvas.style.width=canvas.width*scale+"px";
 canvas.style.height=canvas.height*scale+"px";
}
window.addEventListener("resize",resize);
resize();

// ================= WORLD =================
const tileSize=32;
const view=5;
let world=new Map();

const tiles={
 grass:{color:"#3cb043",solid:false,wild:true},
 wall:{color:"#306230",solid:true,wild:false}
};

function key(x,y){return x+","+y;}
function getTile(x,y){return world.get(key(x,y));}
function setTile(x,y,v){world.set(key(x,y),v);}

function generate(){
 for(let y=-view;y<=view;y++){
  for(let x=-view;x<=view;x++){
   let gx=playerX+x;
   let gy=playerY+y;
   if(!getTile(gx,gy)){
    setTile(gx,gy,Math.random()<0.15?"wall":"grass");
   }
  }
 }
}

// ================= DATA =================
const TYPES=["fire","water","grass"];

function elemental(a,d){
 if(a==="fire"&&d==="grass") return 2;
 if(a==="grass"&&d==="water") return 2;
 if(a==="water"&&d==="fire") return 2;
 if(a==="grass"&&d==="fire") return 0.5;
 if(a==="water"&&d==="grass") return 0.5;
 if(a==="fire"&&d==="water") return 0.5;
 return 1;
}

const MOVES={
 tackle:{name:"Tackle",power:10,pp:20,type:"normal"},
 ember:{name:"Ember",power:15,pp:15,type:"fire",burn:0.2},
 waterGun:{name:"WaterGun",power:15,pp:15,type:"water"},
 vine:{name:"Vine",power:15,pp:15,type:"grass"}
};

function createMonster(type,level){
 return{
  name:type,
  type,
  level,
  maxHp:level*8,
  hp:level*8,
  atk:level+4,
  def:level+3,
  status:null,
  moves:[
   JSON.parse(JSON.stringify(MOVES.tackle)),
   JSON.parse(JSON.stringify(
    type==="fire"?MOVES.ember:
    type==="water"?MOVES.waterGun:
    MOVES.vine
   ))
  ]
 };
}

// ================= PLAYER =================
let playerX=0;
let playerY=0;

let player={
 team:[createMonster("fire",5)],
 storage:[],
 active:0
};

// ================= STATE =================
let state="explore";
let enemy=null;
let turn="player";
let msg="";

// ================= BATTLE =================
function startBattle(){
 enemy=createMonster(
  TYPES[Math.floor(Math.random()*3)],
  4+Math.floor(Math.random()*2)
 );
 state="battle";
 turn="player";
 msg="Wild "+enemy.type+"!";
 updateUI();
}

function damage(a,d,m){
 let base=m.power+a.atk-d.def;
 let stab=a.type===m.type?1.2:1;
 let element=elemental(m.type,d.type);
 let crit=Math.random()<0.1?1.5:1;
 return Math.max(1,Math.floor(base*stab*element*crit));
}

function playerAttack(i){
 if(turn!=="player") return;
 let active=player.team[player.active];
 let move=active.moves[i];
 if(move.pp<=0){ msg="No PP"; return; }
 move.pp--;
 let dmg=damage(active,enemy,move);
 enemy.hp-=dmg;
 msg=move.name+" "+dmg;
 if(enemy.hp<=0){
  msg="Victory";
  setTimeout(()=>{ state="explore"; updateUI(); },800);
  return;
 }
 turn="enemy";
 setTimeout(enemyTurn,600);
}

function enemyTurn(){
 let active=player.team[player.active];
 let move=enemy.moves[0];
 let dmg=damage(enemy,active,move);
 active.hp-=dmg;
 msg="Enemy "+dmg;
 if(active.hp<=0){
  active.hp=active.maxHp;
  state="explore";
  updateUI();
  return;
 }
 turn="player";
}

function capture(){
 let chance=(enemy.maxHp-enemy.hp)/enemy.maxHp;
 if(Math.random()<chance){
  if(player.team.length<3)
    player.team.push(enemy);
  else
    player.storage.push(enemy);
  msg="Captured!";
  setTimeout(()=>{ state="explore"; updateUI(); },800);
 }else{
  msg="Fail!";
  turn="enemy";
  setTimeout(enemyTurn,600);
 }
}

// ================= JOYSTICK =================
const joy=document.getElementById("joystick");
const stick=document.getElementById("stick");
let joyActive=false;

joy.addEventListener("touchstart",()=>joyActive=true);
joy.addEventListener("touchend",()=>{
 joyActive=false;
 stick.style.left="35px";
 stick.style.top="35px";
});

joy.addEventListener("touchmove",e=>{
 if(!joyActive || state!=="explore") return;
 let rect=joy.getBoundingClientRect();
 let x=e.touches[0].clientX-rect.left-60;
 let y=e.touches[0].clientY-rect.top-60;
 let dist=Math.sqrt(x*x+y*y);
 if(dist>40){
  x*=40/dist;
  y*=40/dist;
 }
 stick.style.left=35+x+"px";
 stick.style.top=35+y+"px";

 if(Math.abs(x)>20) playerX+=x>0?1:-1;
 if(Math.abs(y)>20) playerY+=y>0?1:-1;

 generate();
 if(Math.random()<0.05) startBattle();
});

// ================= UI =================
const attack1=document.getElementById("attack1");
const attack2=document.getElementById("attack2");
const captureBtn=document.getElementById("captureBtn");
const menuBtn=document.getElementById("menuBtn");

attack1.onclick=()=>playerAttack(0);
attack2.onclick=()=>playerAttack(1);
captureBtn.onclick=capture;
menuBtn.onclick=()=>{
 state=state==="team"?"explore":"team";
 updateUI();
};

function updateUI(){
 const battleUI=state==="battle";
 attack1.classList.toggle("hidden",!battleUI);
 attack2.classList.toggle("hidden",!battleUI);
 captureBtn.classList.toggle("hidden",!battleUI);
}

// ================= DRAW =================
function draw(){
 ctx.clearRect(0,0,320,288);

 if(state==="explore"){
  generate();
  for(let y=-view;y<=view;y++){
   for(let x=-view;x<=view;x++){
    let t=getTile(playerX+x,playerY+y);
    ctx.fillStyle=tiles[t].color;
    ctx.fillRect((x+view)*32,(y+view)*32,32,32);
   }
  }
  ctx.fillStyle="red";
  ctx.fillRect(view*32+8,view*32+8,16,16);
 }

 if(state==="battle"){
  ctx.fillStyle="#000";
  ctx.fillRect(0,0,320,288);
  ctx.fillStyle="#fff";
  ctx.fillText("Enemy "+enemy.type,20,20);
  ctx.fillText("HP "+enemy.hp+"/"+enemy.maxHp,20,40);
  let active=player.team[player.active];
  ctx.fillText("You "+active.name,20,100);
  ctx.fillText("HP "+active.hp+"/"+active.maxHp,20,120);
  ctx.fillText(msg,20,200);
 }

 requestAnimationFrame(draw);
}

updateUI();
generate();
draw();
</script>
</body>
</html>